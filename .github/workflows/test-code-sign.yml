name: Test code signing

on:
  workflow_dispatch:

jobs:
  test-signing:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create real dummy exe
        shell: pwsh
        run: |
          $code = 'using System;
          public class Program {
              public static void Main() {
                  System.Console.WriteLine("Hello from signed dummy exe");
              }
          }'
          Add-Type -TypeDefinition $code -OutputAssembly dummy.exe

      - name: Decode 3 year PFX certificate from GitHub Secrets
        shell: pwsh
        run: |
          $base64String = "${{ secrets.ADDAX_3YEAR_2025_BASE64 }}"
          [IO.File]::WriteAllBytes("addax_3year_2025.pfx", [Convert]::FromBase64String($base64String))

      - name: Sign dummy exe
        shell: cmd
        run: |
          "C:/Program Files (x86)/Windows Kits/10/bin/10.0.26100.0/x64/signtool.exe" sign ^
            /f addax_3year_2025.pfx ^
            /p "${{ secrets.ADDAX_3YEAR_2025_PFX_PASSWORD }}" ^
            /tr http://timestamp.digicert.com ^
            /td SHA256 ^
            /fd SHA256 ^
            dummy.exe

      - name: Verify signature
        shell: cmd
        run: |
          "C:/Program Files (x86)/Windows Kits/10/bin/10.0.26100.0/x64/signtool.exe" verify /pa /v dummy.exe
